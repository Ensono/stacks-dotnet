contexts:
  powershell:
    executable:
      bin: docker
      args:
        - run
        - --rm
        - -v
        - ${PWD}:/app
        - -v
        - /var/run/docker.sock:/var/run/docker.sock
        - -e
        - PSModulePath=/modules
        - -w
        - /app
        - --env-file
        - envfile
        - ensonostackseuweirdfmu.azurecr.io/ensono/eir-infrastructure:1.1.159
        - pwsh
        - -NoProfile
        - -Command
    quote: "'"
    envfile:
      generate: true
      exclude:
        - PATH
        - HOME
        - KUBECONFIG

  container:auth:
    container:
      name: ensono/eir-infrastructure:1.1.251
      # this is only required because the infra container uses docker and not podman
      enable_dind: true

  container:builder:
    container:
      name: quay.io/podman/stable:v5.2.3
      container_args:
        - --cap-add=sys_admin
        - --cap-add mknod
        - --cap-add SYS_CHROOT
        - --cap-add SETFCAP
        - --cap-add SYS_RESOURCE
        - --device=/dev/fuse
        # Disabling apparmor is still better than running --privileged
        - --security-opt seccomp=unconfined
        - --security-opt apparmor=unconfined
        - --security-opt label=disable
    env:
      DOCKER_CONFIG: /workspace/.taskctl/.docker
      container: true

  powershell-dotnet:
    executable:
      bin: docker
      args:
        - run
        - --rm
        - -v
        - ${PWD}:/app
        - -v
        - /var/run/docker.sock:/var/run/docker.sock
        - -e
        - PSModulePath=/modules
        - -w
        - /app
        - --env-file
        - envfile
        - ensonostackseuweirdfmu.azurecr.io/ensono/eir-dotnet:1.1.159
        - pwsh
        - -NoProfile
        - -Command
    quote: "'"
    env:
      DOTNET_ARGUMENTS: "-v q /p:CollectCoverage=true /p:CoverletOutputFormat=opencover"
    envfile:
      generate: true
      exclude:
        - PATH
        - JAVA_HOME
        - HOME
        - KUBECONFIG
