variables:
- group: amido-stacks-infra-credentials-nonprod
- group: amido-stacks-menu-api
- group: amido-stacks-infra-nonprod
- group: amido-stacks-global
- name: Version.MajorMinor
  value: 1.0
- name: Version.Revision
  value: $[counter(variables['Version.MajorMinor'], 0)]

name: $(build.SourceBranchName)-init

resources:
- repo: self

pool:
  vmImage: 'ubuntu-16.04'

steps:

- script: echo '##vso[build.updatebuildnumber]$(Docker.ImageTag)'
  displayName: Update Build Number

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: './src/tests/Amido.Stacks.E2e.Tests'
    feedsToUse: 'select'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: './src/tests/Amido.Stacks.E2e.Tests'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: true

- script: |
    az login --service-principal --username $AZURE_CLIENT_ID --password $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    az account set -s $AZURE_SUBSCRIPTION_ID
    az acr login --name $ACR_NAME
  displayName: Azure login
  env:
    AZURE_CLIENT_SECRET: $(azure_client_secret)

#  This is now a windows image, so can't run on hosted Linux build agents, commented out for now
# - script: |
#     docker run -v "$(pwd):/repo" gittools/gitversion | tee gitversion.json
#     export FULLSEMVER=$(cat gitversion.json | jq .FullSemVer -r)
#     export FULLSEMVERPARSED=$(echo $FULLSEMVER | sed "s/+/./g")
#     echo "##vso[build.updatebuildnumber]$FULLSEMVERPARSED"
#   displayName: GitVersion
#   workingDirectory: $(Build.SourcesDirectory)

- script: |
    echo $BUILD_BUILDNUMBER
    docker build . -t $DOCKER_IMAGENAME:$DOCKER_IMAGETAG -t $ACR_NAME.azurecr.io/$DOCKER_IMAGENAME:$DOCKER_IMAGETAG -t $ACR_NAME.azurecr.io/$DOCKER_IMAGENAME:latest
    docker push $ACR_NAME.azurecr.io/$DOCKER_IMAGENAME
  displayName: Docker Build and Push container
  workingDirectory: $(Build.SourcesDirectory)/$(Docker.DockerfilePath)

- task: PublishBuildArtifacts@1
  displayName: Publish Artifact - Deploy scripts
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/deploy/scripts'
    ArtifactName: 'deploy'

- task: PublishBuildArtifacts@1
  displayName: Publish Artifact - YML files 
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/$(Kubernetes.YMLfilepath)'
    ArtifactName: 'yml'
