name: $(build.SourceBranchName)-init

# A pipeline with no trigger
trigger: none

resources:
- repo: self

variables:
- group: amido-stacks-infra-credentials-nonprod

# Versioning
- name: Version.Major
  value: 1
- name: Version.Minor
  value: 2
- name: Version.MajorMinor
  value: $(Version.Major).$(Version.Minor)
- name: Version.Revision
  value: $[counter(variables['Version.MajorMinor'], 0)]

# Tests
- name: Test.ProviderContractTestProjectSourcePath
  value: '$(Build.SourcesDirectory)/src/api/xxAMIDOxx.xxSTACKSxx.API.ContractTests'

# Docker Config
- name: Docker.ImageTag
  value: $(Version.MajorMinor).$(Version.Revision)-$(build.sourcebranchname)

# Package Info
- name: Package.File
  value: scripts-0.0.32-master.tar.gz
- name: Package.SAS
  value: 'se=2019-09-08T10%3A15Z&sp=rl&sv=2018-03-28&ss=b&srt=sco&sig=EP4xmbIf3pcJK4dbUrmxwLP9gFXVVyDV2FNYSTvAdR4%3D'

# Pact Broker Info
- name: Test.PactBrokerUrl
  value: https://amido-stacks.pact.dius.com.au
# Specific Contract Test Variable Declarations
- name: BROKER_URL
  value: $(Test.PactBrokerUrl)
- name: BUILD_NUMBER
  value: $(Docker.ImageTag)
- name: BROKER_TOKEN
  value: $(Test.PactBearerToken)

stages:
- stage: Build
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    continueOnError: False
    steps:
    - script: echo '##vso[build.updatebuildnumber]$(Docker.ImageTag)'
      displayName: Update Build Number

    - bash: | 
        wget -O $(Build.BinariesDirectory)/$(Package.File)  'https://amidostackspkgukstmp.blob.core.windows.net/packages/$(Package.File)?$(Package.SAS)'
      displayName: Get DevOps Scripts
      workingDirectory: $(Build.BinariesDirectory)
    
    - task: ExtractFiles@1
      inputs:
        archiveFilePatterns: '$(Build.BinariesDirectory)/$(Package.File)' 
        destinationFolder: $(Build.BinariesDirectory)/DevOps
      displayName: Extract DevOps Scripts

    - task: DotNetCoreCLI@2
      displayName: 'Run Provider Contract Tests'
      inputs:
        command: test
        projects: '$(Test.ProviderContractTestProjectSourcePath)/*.csproj'
        arguments: '-v n'
        testRunTitle: 'Provider Contract Tests'
      continueOnError: true
